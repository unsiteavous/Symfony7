# Mise en production
Dans une id√©e de d√©ploiement continu, il est souhaitable de faire des mises en production r√©guli√®rement.

La premi√®re chose √† laquelle on va se confronter, c'est la capacit√© √† appeler l'API depuis ailleurs que ce serveur. Quand on travaille avec postman, on a l'impression que tout fonctionne, mais c'est une illusion. Postman fait des appels api qui sont pass√©s comme s'ils venaient d'un serveur, et pas d'un front. Cela change beaucoup de choses. Et donc lorsqu'on essaie de faire un fetch depuis JS, on s'aper√ßoit que les requ√™tes sont bloqu√©es √† cause des CORS.

## Disponibilit√© d'API

On va donc devoir dire √† symfony de nous laisser acc√©der √† notre API, m√™me en local ! 
Pour cela, on va installer un bundle suppl√©mentaire, qui va impl√©menter pour nous la gestion des *Cross-Origin Resource Sharing*.  
[üìú Documentation de NelmioCorsBundle](https://symfony.com/bundles/NelmioCorsBundle/current/index.html)

On va commencer par demander √† composer de l'installer :

```bash
composer require nelmio/cors-bundle
```
Ensuite, dans le fichier `nelmio_cors.yaml`, on va venir lui dire qu'on veut que dans le cas de nos urls d'API, on autorise le site front √† y acc√©der : 

```yaml
nelmio_cors:
    defaults:
        origin_regex: true
        allow_origin: ['%env(CORS_ALLOW_ORIGIN)%']
        allow_methods: ['GET', 'OPTIONS', 'POST', 'PUT', 'PATCH', 'DELETE']
        allow_headers: ['Content-Type', 'Authorization']
        expose_headers: ['Link']
        max_age: 3600
    paths:
        '^/api':
            allow_origin: ['http://virtualHost']
```

Tous les r√©glages par d√©faut sont int√©ressants, on peut bien entendu les compl√©ter, les modifier, ou les red√©finir dans nos paths. Vous retrouverez tout √ßa dans la documentation.

## Mise en prod

[üìú Documentation de la mise en prod de symfony](https://symfony.com/doc/current/deployment.html)

On a beaucoup de chance, comme symfony d√©barque avec son propre serveur, nous pouvons tester une premi√®re mise en ligne avec wampserver.

Pour cela, cr√©ez un virtualhost qui pointe sur votre dossier public de votre projet symfony. Mais une fois qu'on se rend sur ce virtualhost, on constate qu'on voit la superbe page d'installation de symfony, mais impossible d'aller sur une page ! le router ne marche pas... Et c'est normal : il n'y a pas de fichier `.htaccess` dans notre projet.

Pour le mettre en place, pas d'inqui√©tude, symfony a un autre paquet √† installer : 

```bash
composer require symfony/apache-pack
```
Et voil√†, on peut acc√©der √† notre site ! 

Bon, c'est pas pour autant que nous avons fait une mise en prod. Si on utilise webpack pour le front, il faut compiler avec npm : 

```npm
npm run build
```
### Passer le `.env` en prod
Et ce n'est pas tout : il faut aussi modifier la configuration de notre site. Quand vous passerez sur le serveur, il faudra bien modifier les infos de BDD.

Pour faire cela, composer nous donne une commande : 
```bash
composer dump-env prod
```
Cela cr√©e un fichier `.env.local.php`, qui sera toujours lu en priorit√© sur tous les autres .env qui pourraient se trouver dans le coin. Evidemment, c'est le seul qu'on mettra sur le serveur... 

Bon, quand on a fait tout √ßa, c'est fini ? Et non ! üòú

### Enlever les fichiers inutiles.
Si on verse tout notre projet comme √ßa sur le serveur, on va mettre un grand nombre de trucs qui servent √† rien. 
Pour √©viter √ßa, on va copier seulement quelques fichiers dans un nouveau dossier : 
* assets
* bin
* config
* migrations
* public
* src
* templates
* .env.local.php
* composer.json
* composer.lock
* importmap.php
* symfony.lock

**C'est tout !!!**

Ensuite on fait cette commande :
```bash
composer install --no-dev --optimize-autoloader
```

Cela t√©l√©charge uniquement les d√©pendances n√©cessaires √† la production (par exemple, pas fakerphp), et √ßa optimise l'autoloader √† fond.

Puis il faut nettoyer le cache de Symfony :
```bash
symfony console cache:clear
```

Et l√†, √ßa y est tout est pr√™t. Si vous retournez √† pr√©sent sur votre virtualHost, vous pouvez voir votre site comme sit vous √©tiez en ligne.

Et dans notre cas, pour pouvoir mettre notre application sur le serveur de simplon, on utilisera en plus un fichier nginx.conf comme on a l'habitude de le faire.

Bravo vous avez une app symfony mise en ligne ! üëçüëèüéâ